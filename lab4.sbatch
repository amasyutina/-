
#!/bin/bash  # Указывает, что скрипт должен выполняться в интерпретаторе bash

#SBATCH -p gpuserv  # Указывает, что задача будет запущена на GPU-сервере
#SBATCH -J lab4_5  # Задает имя задачи (lab4_5)
#SBATCH -o lab4_5.%j.out  # Указывает файл для стандартного вывода, где %j будет заменено на ID задачи
#SBATCH -e lab4_5.%j.err  # Указывает файл для стандартного вывода ошибок, где %j будет заменено на ID задачи
#SBATCH --mem=10G  # Запрашивает 10 ГБ оперативной памяти для задачи
#SBATCH -t 00:20:00  # Указывает максимальное время выполнения задачи (20 минут)

# Вывод информации о запуске задачи
echo "=== Запуск задачи на GPU ==="
echo "Узел: $(hostname)"  # Выводит имя узла, на котором выполняется задача
echo "Начало: $(date)"  # Выводит текущее время начала выполнения
echo "Рабочий каталог: $(pwd)"  # Выводит текущий рабочий каталог
echo "ID задачи: $SLURM_JOB_ID"  # Выводит ID текущей задачи SLURM

# 1. Загружаем модуль CUDA
echo "Загружаю модуль CUDA..."  # Сообщение о загрузке модуля CUDA
module load nvidia/cuda || {  # Загружает модуль CUDA; если не удается, выполняет блок ошибок
    echo "Ошибка: не удалось загрузить модуль CUDA"  # Сообщение об ошибке при загрузке
    exit 1  # Завершает выполнение скрипта с кодом ошибки 1
}

# 2. Проверяем доступность nvcc
echo "Проверяю доступность nvcc..."  # Сообщение о проверке доступности компилятора nvcc
if ! command -v nvcc &> /dev/null; then  # Проверяет, установлен ли nvcc и доступен ли в PATH
    echo "Ошибка: nvcc не найден в PATH"  # Сообщение об ошибке, если nvcc не найден
    exit 1  # Завершает выполнение скрипта с кодом ошибки 1
fi

# 3. Компилируем CUDA‑программу с оптимизациями
echo "Начинаю компиляцию lab4_5.cu..."  # Сообщение о начале компиляции программы lab4_5.cu
nvcc -arch=sm_70 -O3 -Xcompiler -Wall lab4_5.cu -o lab4_5 || {  # Компилирует программу с оптимизацией и предупреждениями
    echo "Ошибка компиляции!"  # Сообщение об ошибке компиляции
    exit 1  # Завершает выполнение скрипта с кодом ошибки 1
}
echo "Компиляция завершена успешно."  # Сообщение о успешной компиляции

# 4. Запускаем исполняемый файл
echo "Запускаю вычисления..."  # Сообщение о запуске вычислений
./lab4_5  # Запуск скомпилированной программы lab4_5

# 5. Проверяем статус завершения
if [ $? -eq 0 ]; then  # Проверяет код завершения предыдущей команды (0 - успех)
    echo "Задача выполнена успешно."  # Сообщение о успешном выполнении задачи
else
    echo "Задача завершилась с ошибкой (код: $?)"  # Сообщение об ошибке с выводом кода завершения
fi

echo "Конец: $(date)"  # Выводит текущее время окончания выполнения скрипта